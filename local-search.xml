<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>为了安装 Python3.10+，我被迫在 CentOS7 上手动升级了OpenSSL</title>
    <link href="/2025/11/30/20251130-centos7%E6%9B%B4%E6%96%B0openssl/"/>
    <url>/2025/11/30/20251130-centos7%E6%9B%B4%E6%96%B0openssl/</url>
    
    <content type="html"><![CDATA[<h2 id="发挥余热的CentOS7"><a href="#发挥余热的CentOS7" class="headerlink" title="发挥余热的CentOS7"></a>发挥余热的CentOS7</h2><p>虽然CentOS7已经停止维护了,但是还有很多服务器都在运行着这个版本,自带的 OpenSSL 版本通常停留在 1.0.2k，这个版本不仅已经停止支持，而且不支持许多现代加密算法。当你尝试安装 Python 3.10+，或者部署最新的 Nginx 时，往往会报错要求OpenSSL1.1.1 或更高版本。</p><p>所以本文将手把手教你如何通过源码编译的方式，在CentOS7上安全地升级 OpenSSL。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>OpenSSL是Linux系统的核心组件，升级不当可能导致 yum、ssh 等工具无法使用。请在操作前务必对服务器进行快照备份，并建议在测试环境先演练一遍。</p><h3 id="第一步-检查当前的版本"><a href="#第一步-检查当前的版本" class="headerlink" title="第一步:检查当前的版本"></a>第一步:检查当前的版本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">openssl version<br><span class="hljs-comment"># 输出示例: OpenSSL 1.0.2k-fips  26 Jan 2017    </span><br></code></pre></td></tr></table></figure><!-- ![logo](./20251130-centos7更新openssl/p1.png) --><img src="/2025/11/30/20251130-centos7%E6%9B%B4%E6%96%B0openssl/p1.png" class="" title="p1"><h3 id="第二步：安装编译依赖"><a href="#第二步：安装编译依赖" class="headerlink" title="第二步：安装编译依赖"></a>第二步：安装编译依赖</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> yum install -y gcc make pcre-devel zlib-devel<br></code></pre></td></tr></table></figure><p>注意: OpenSSL 3.x 可能需要更新版本的 Perl，如果系统 Perl 太老，编译过程会提示缺少 IPC&#x2F;Cmd.pm 模块，安装 perl-core 通常能解决。</p><h3 id="第三步：下载OpenSSL源码"><a href="#第三步：下载OpenSSL源码" class="headerlink" title="第三步：下载OpenSSL源码"></a>第三步：下载OpenSSL源码</h3><p>你可以选择升级到 1.1.1w (兼容性好) 或 3.x (最新)。这里以目前最常用的 OpenSSL 1.1.1w 为例（许多旧软件对 3.x 兼容性尚需验证，1.1.1 最稳妥，根据自己的需求选择）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local/src<br>wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz<br><br><span class="hljs-comment"># 解压</span><br>tar -zxvf openssl-1.1.1w.tar.gz<br><span class="hljs-built_in">cd</span> openssl-1.1.1w<br></code></pre></td></tr></table></figure><h3 id="第四步：编译与安装"><a href="#第四步：编译与安装" class="headerlink" title="第四步：编译与安装"></a>第四步：编译与安装</h3><p>这里我们将其安装到 &#x2F;usr&#x2F;local&#x2F;openssl 目录下，避免直接覆盖系统文件导致意外。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 配置编译选项</span><br><span class="hljs-comment"># --prefix 指定安装目录</span><br><span class="hljs-comment"># --openssldir 指定配置文件目录</span><br><span class="hljs-comment"># shared 编译成动态库</span><br>./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl shared zlib<br><br><span class="hljs-comment"># 编译 </span><br>make<br><br><span class="hljs-comment"># 安装</span><br><span class="hljs-built_in">sudo</span> make install<br></code></pre></td></tr></table></figure><h3 id="第五步：配置系统环境（关键步骤）"><a href="#第五步：配置系统环境（关键步骤）" class="headerlink" title="第五步：配置系统环境（关键步骤）"></a>第五步：配置系统环境（关键步骤）</h3><p>安装完成后，系统默认还是会调用旧的 OpenSSL。我们需要进行替换和链接。</p><ol><li>备份旧版本二进制文件</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mv</span> /usr/bin/openssl /usr/bin/openssl.bak<br></code></pre></td></tr></table></figure><ol start="2"><li>创建新版本的软链接</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ln</span> -s /usr/local/openssl/bin/openssl /usr/bin/openssl<br></code></pre></td></tr></table></figure><ol start="3"><li>更新动态链接库数据</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 将新的库路径写入配置文件</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/usr/local/openssl/lib&quot;</span> | <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/ld.so.conf.d/openssl.conf<br><br><span class="hljs-comment"># 刷新动态库缓存</span><br><span class="hljs-built_in">sudo</span> ldconfig<br></code></pre></td></tr></table></figure><h3 id="第六步：验证与测试"><a href="#第六步：验证与测试" class="headerlink" title="第六步：验证与测试"></a>第六步：验证与测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">openssl version<br><span class="hljs-comment"># 输出示例: OpenSSL 1.1.1w  11 Sep 2023</span><br></code></pre></td></tr></table></figure><!-- ![logo](./20251130-centos7更新openssl/p2.png) --><img src="/2025/11/30/20251130-centos7%E6%9B%B4%E6%96%B0openssl/p2.png" class="" title="p2"><p>如果能看到新版本号，且没有报错，说明升级成功！</p><p>  检查 ssh 和 yum 是否正常： 这一点非常重要，尝试新开一个终端连接服务器，并执行一下 yum check-update，确保系统基础功能未受影响。</p><h3 id="常见问题排查"><a href="#常见问题排查" class="headerlink" title="常见问题排查"></a>常见问题排查</h3><p>Q: 运行 openssl 提示 error while loading shared libraries: libssl.so.1.1? A: 这是因为系统找不到新的动态库。请检查 &#x2F;etc&#x2F;ld.so.conf.d&#x2F; 下是否配置了正确的路径（lib 或 lib64），并务必执行 ldconfig。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>虽然CentOS7廉颇老矣，但通过手动升级 OpenSSL，我们依然可以让它发挥余热，支持更新的开发环境。希望这篇教程能帮到你！</p>]]></content>
    
    
    
    <tags>
      
      <tag>centos</tag>
      
      <tag>openssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用 FastAPI 和 yt-dlp 构建 YouTube 下载器</title>
    <link href="/2025/06/07/Building-a-YouTube-Downloader-with-FastAPI/"/>
    <url>/2025/06/07/Building-a-YouTube-Downloader-with-FastAPI/</url>
    
    <content type="html"><![CDATA[<h1 id="使用-FastAPI-和-yt-dlp-构建-YouTube-下载器"><a href="#使用-FastAPI-和-yt-dlp-构建-YouTube-下载器" class="headerlink" title="使用 FastAPI 和 yt-dlp 构建 YouTube 下载器"></a>使用 FastAPI 和 yt-dlp 构建 YouTube 下载器</h1><p>在这份综合指南中，我们将使用 <strong>FastAPI</strong> 和 <strong>yt-dlp</strong> 构建一个现代化的 YouTube 视频下载器。我们的应用程序将具有简洁的 Web 界面、实时下载进度跟踪和强大的错误处理功能，以应对 YouTube 不断发展的反爬虫措施。</p><h2 id="我们将构建什么"><a href="#我们将构建什么" class="headerlink" title="我们将构建什么"></a>我们将构建什么</h2><ul><li><strong>Web 界面</strong>：使用 Bootstrap 构建的简洁、响应式 UI</li><li><strong>实时进度跟踪</strong>：实时下载进度更新</li><li><strong>格式选择</strong>：从各种视频&#x2F;音频质量选项中选择</li><li><strong>任务管理</strong>：查看、监控和管理下载任务</li><li><strong>错误处理</strong>：处理 YouTube 的限制</li><li><strong>文件管理</strong>：安全的文件服务和下载</li></ul><h2 id="使用的技术"><a href="#使用的技术" class="headerlink" title="使用的技术"></a>使用的技术</h2><ul><li><strong>后端</strong>：FastAPI (Python)</li><li><strong>视频处理</strong>：yt-dlp</li><li><strong>数据库</strong>：SQLite</li><li><strong>前端</strong>：HTML、CSS、JavaScript、Bootstrap</li></ul><h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><p>在开始之前，请确保你有：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Python 3.8+</span><br>python --version<br><br><span class="hljs-comment"># Required packages</span><br>pip install fastapi uvicorn yt-dlp sqlalchemy python-multipart jinja2<br></code></pre></td></tr></table></figure><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nix">yt-dlp-web<span class="hljs-symbol">/</span><br>├── app<span class="hljs-symbol">/</span><br>│   ├── main.py              <span class="hljs-comment"># FastAPI application</span><br>│   ├── models.py            <span class="hljs-comment"># Database models</span><br>│   ├── database.py          <span class="hljs-comment"># Database configuration</span><br>│   └── youtube_downloader.py <span class="hljs-comment"># Core download logic</span><br>├── static<span class="hljs-symbol">/</span><br>│   ├── script.js           <span class="hljs-comment"># Frontend JavaScript</span><br>│   └── style.css           <span class="hljs-comment"># Custom styles</span><br>├── templates<span class="hljs-symbol">/</span><br>│   └── index.html          <span class="hljs-comment"># Main HTML template</span><br>├── downloads<span class="hljs-symbol">/</span>              <span class="hljs-comment"># Downloaded files directory</span><br>└── requirements.txt        <span class="hljs-comment"># Python dependencies</span><br></code></pre></td></tr></table></figure><h2 id="数据库模型"><a href="#数据库模型" class="headerlink" title="数据库模型"></a>数据库模型</h2><p>让我们从定义数据库模型开始：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/models.py</span><br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Integer, String, Float, DateTime, Text<br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> func<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum<br><br>Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskStatus</span>(<span class="hljs-built_in">str</span>, Enum):<br>    PENDING = <span class="hljs-string">&quot;pending&quot;</span><br>    DOWNLOADING = <span class="hljs-string">&quot;downloading&quot;</span><br>    COMPLETED = <span class="hljs-string">&quot;completed&quot;</span><br>    FAILED = <span class="hljs-string">&quot;failed&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadTask</span>(<span class="hljs-title class_ inherited__">Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;download_tasks&quot;</span><br>    <br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)<br>    url = Column(String, nullable=<span class="hljs-literal">False</span>)<br>    title = Column(String, nullable=<span class="hljs-literal">True</span>)<br>    status = Column(String, default=TaskStatus.PENDING)<br>    progress = Column(Float, default=<span class="hljs-number">0.0</span>)<br>    file_path = Column(String, nullable=<span class="hljs-literal">True</span>)<br>    file_size = Column(Integer, nullable=<span class="hljs-literal">True</span>)<br>    error_message = Column(Text, nullable=<span class="hljs-literal">True</span>)<br>    format_id = Column(String, nullable=<span class="hljs-literal">True</span>)<br>    created_at = Column(DateTime, default=func.now())<br>    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_dict</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">id</span>,<br>            <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-variable language_">self</span>.url,<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-variable language_">self</span>.title,<br>            <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-variable language_">self</span>.status,<br>            <span class="hljs-string">&quot;progress&quot;</span>: <span class="hljs-variable language_">self</span>.progress,<br>            <span class="hljs-string">&quot;file_path&quot;</span>: <span class="hljs-variable language_">self</span>.file_path,<br>            <span class="hljs-string">&quot;file_size&quot;</span>: <span class="hljs-variable language_">self</span>.file_size,<br>            <span class="hljs-string">&quot;error_message&quot;</span>: <span class="hljs-variable language_">self</span>.error_message,<br>            <span class="hljs-string">&quot;format_id&quot;</span>: <span class="hljs-variable language_">self</span>.format_id,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: <span class="hljs-variable language_">self</span>.created_at.isoformat() <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.created_at <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: <span class="hljs-variable language_">self</span>.updated_at.isoformat() <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.updated_at <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        &#125;<br></code></pre></td></tr></table></figure><h2 id="YouTube-下载类"><a href="#YouTube-下载类" class="headerlink" title="YouTube 下载类"></a>YouTube 下载类</h2><p>我们应用程序的核心是 YouTube 下载器类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/youtube_downloader.py</span><br><span class="hljs-keyword">import</span> yt_dlp<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>, <span class="hljs-type">Optional</span><br><span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> TaskStatus<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">YouTubeDownloader</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, download_dir: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;./downloads&quot;</span></span>):<br>        <span class="hljs-variable language_">self</span>.download_dir = download_dir<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_video_info</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;Extract video information without downloading&quot;&quot;&quot;</span><br>        ydl_opts = &#123;<br>            <span class="hljs-string">&#x27;quiet&#x27;</span>: <span class="hljs-literal">True</span>,<br>            <span class="hljs-string">&#x27;no_warnings&#x27;</span>: <span class="hljs-literal">True</span>,<br>            <span class="hljs-string">&#x27;extract_flat&#x27;</span>: <span class="hljs-literal">False</span>,<br>            <span class="hljs-string">&#x27;extractor_args&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;youtube&#x27;</span>: &#123;<br>                    <span class="hljs-string">&#x27;player_client&#x27;</span>: [<span class="hljs-string">&#x27;tv&#x27;</span>, <span class="hljs-string">&#x27;mweb&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span>],<br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&#x27;http_headers&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&#x27;</span><br>            &#125;,<br>            <span class="hljs-string">&#x27;ignoreerrors&#x27;</span>: <span class="hljs-literal">True</span><br>        &#125;<br>        <br>        <span class="hljs-keyword">with</span> yt_dlp.YoutubeDL(ydl_opts) <span class="hljs-keyword">as</span> ydl:<br>            info = ydl.extract_info(url, download=<span class="hljs-literal">False</span>)<br>            <br>            <span class="hljs-comment"># Process and categorize available formats</span><br>            formats = <span class="hljs-variable language_">self</span>._process_formats(info.get(<span class="hljs-string">&#x27;formats&#x27;</span>, []))<br>            <br>            <span class="hljs-keyword">return</span> &#123;<br>                <span class="hljs-string">&#x27;title&#x27;</span>: info.get(<span class="hljs-string">&#x27;title&#x27;</span>, <span class="hljs-string">&#x27;Unknown&#x27;</span>),<br>                <span class="hljs-string">&#x27;duration&#x27;</span>: info.get(<span class="hljs-string">&#x27;duration&#x27;</span>, <span class="hljs-number">0</span>),<br>                <span class="hljs-string">&#x27;uploader&#x27;</span>: info.get(<span class="hljs-string">&#x27;uploader&#x27;</span>, <span class="hljs-string">&#x27;Unknown&#x27;</span>),<br>                <span class="hljs-string">&#x27;view_count&#x27;</span>: info.get(<span class="hljs-string">&#x27;view_count&#x27;</span>, <span class="hljs-number">0</span>),<br>                <span class="hljs-string">&#x27;thumbnail&#x27;</span>: info.get(<span class="hljs-string">&#x27;thumbnail&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>),<br>                <span class="hljs-string">&#x27;webpage_url&#x27;</span>: info.get(<span class="hljs-string">&#x27;webpage_url&#x27;</span>, url),<br>                <span class="hljs-string">&#x27;formats&#x27;</span>: formats<br>            &#125;<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_video</span>(<span class="hljs-params">self, task_id: <span class="hljs-built_in">int</span>, url: <span class="hljs-built_in">str</span>, format_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;best&#x27;</span>, </span><br><span class="hljs-params">                      progress_callback: <span class="hljs-type">Optional</span>[<span class="hljs-type">Callable</span>] = <span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Download video in a separate thread&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_thread</span>():<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># Ensure download directory exists</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-variable language_">self</span>.download_dir):<br>                    os.makedirs(<span class="hljs-variable language_">self</span>.download_dir)<br>                <br>                <span class="hljs-comment"># Configure yt-dlp options</span><br>                ydl_opts = &#123;<br>                    <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-variable language_">self</span>._get_format_selector(format_id),<br>                    <span class="hljs-string">&#x27;outtmpl&#x27;</span>: os.path.join(<span class="hljs-variable language_">self</span>.download_dir, <span class="hljs-string">&quot;%(title)s-%(id)s.%(ext)s&quot;</span>),<br>                    <span class="hljs-string">&#x27;writeinfojson&#x27;</span>: <span class="hljs-literal">True</span>,<br>                    <span class="hljs-string">&#x27;merge_output_format&#x27;</span>: <span class="hljs-string">&#x27;mp4&#x27;</span>,<br>                    <span class="hljs-string">&#x27;prefer_ffmpeg&#x27;</span>: <span class="hljs-literal">True</span>,<br>                    <span class="hljs-string">&#x27;extractor_args&#x27;</span>: &#123;<br>                        <span class="hljs-string">&#x27;youtube&#x27;</span>: &#123;<br>                            <span class="hljs-string">&#x27;player_client&#x27;</span>: [<span class="hljs-string">&#x27;tv&#x27;</span>, <span class="hljs-string">&#x27;mweb&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span>],<br>                        &#125;<br>                    &#125;,<br>                    <span class="hljs-string">&#x27;retries&#x27;</span>: <span class="hljs-number">3</span>,<br>                    <span class="hljs-string">&#x27;fragment_retries&#x27;</span>: <span class="hljs-number">3</span>,<br>                    <span class="hljs-string">&#x27;socket_timeout&#x27;</span>: <span class="hljs-number">30</span>,<br>                &#125;<br>                <br>                <span class="hljs-keyword">if</span> progress_callback:<br>                    ydl_opts[<span class="hljs-string">&#x27;progress_hooks&#x27;</span>] = [<span class="hljs-variable language_">self</span>._progress_hook(task_id, progress_callback)]<br>                <br>                <span class="hljs-keyword">with</span> yt_dlp.YoutubeDL(ydl_opts) <span class="hljs-keyword">as</span> ydl:<br>                    ydl.download([url])<br>                    <br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-keyword">if</span> progress_callback:<br>                    progress_callback(task_id, <span class="hljs-number">0</span>, TaskStatus.FAILED, <span class="hljs-literal">None</span>, <span class="hljs-built_in">str</span>(e))<br>        <br>        thread = threading.Thread(target=download_thread)<br>        thread.daemon = <span class="hljs-literal">True</span><br>        thread.start()<br>        <span class="hljs-keyword">return</span> thread<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_progress_hook</span>(<span class="hljs-params">self, task_id: <span class="hljs-built_in">int</span>, progress_callback: <span class="hljs-type">Callable</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Progress tracking hook for yt-dlp&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params">d</span>):<br>            <span class="hljs-keyword">if</span> d[<span class="hljs-string">&#x27;status&#x27;</span>] == <span class="hljs-string">&#x27;downloading&#x27;</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;total_bytes&#x27;</span> <span class="hljs-keyword">in</span> d:<br>                    progress = (d[<span class="hljs-string">&#x27;downloaded_bytes&#x27;</span>] / d[<span class="hljs-string">&#x27;total_bytes&#x27;</span>]) * <span class="hljs-number">100</span><br>                <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;total_bytes_estimate&#x27;</span> <span class="hljs-keyword">in</span> d:<br>                    progress = (d[<span class="hljs-string">&#x27;downloaded_bytes&#x27;</span>] / d[<span class="hljs-string">&#x27;total_bytes_estimate&#x27;</span>]) * <span class="hljs-number">100</span><br>                <span class="hljs-keyword">else</span>:<br>                    progress = <span class="hljs-number">0</span><br>                <br>                progress_callback(task_id, progress, TaskStatus.DOWNLOADING)<br>                <br>            <span class="hljs-keyword">elif</span> d[<span class="hljs-string">&#x27;status&#x27;</span>] == <span class="hljs-string">&#x27;finished&#x27;</span>:<br>                filename = d.get(<span class="hljs-string">&#x27;filename&#x27;</span>)<br>                <span class="hljs-keyword">if</span> filename:<br>                    progress_callback(task_id, <span class="hljs-number">100.0</span>, TaskStatus.COMPLETED, filename)<br>                <br>        <span class="hljs-keyword">return</span> hook<br></code></pre></td></tr></table></figure><h2 id="FastAPI-应用"><a href="#FastAPI-应用" class="headerlink" title="FastAPI 应用"></a>FastAPI 应用</h2><p>现在让我们构建 FastAPI 应用程序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># app/main.py</span><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Depends, HTTPException, Request<br><span class="hljs-keyword">from</span> fastapi.staticfiles <span class="hljs-keyword">import</span> StaticFiles<br><span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> HTMLResponse, FileResponse<br><span class="hljs-keyword">from</span> fastapi.templating <span class="hljs-keyword">import</span> Jinja2Templates<br><span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware<br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> Session<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> database <span class="hljs-keyword">import</span> get_db, create_tables, DOWNLOAD_DIR<br><span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> DownloadTask, TaskStatus<br><span class="hljs-keyword">from</span> youtube_downloader <span class="hljs-keyword">import</span> YouTubeDownloader<br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><br><span class="hljs-comment"># Initialize FastAPI app</span><br>app = FastAPI(title=<span class="hljs-string">&quot;YouTube Downloader&quot;</span>, description=<span class="hljs-string">&quot;Modern YouTube video downloader&quot;</span>)<br><br><span class="hljs-comment"># Add CORS middleware</span><br>app.add_middleware(<br>    CORSMiddleware,<br>    allow_origins=[<span class="hljs-string">&quot;*&quot;</span>],<br>    allow_credentials=<span class="hljs-literal">True</span>,<br>    allow_methods=[<span class="hljs-string">&quot;*&quot;</span>],<br>    allow_headers=[<span class="hljs-string">&quot;*&quot;</span>],<br>)<br><br><span class="hljs-comment"># Initialize components</span><br>downloader = YouTubeDownloader(DOWNLOAD_DIR)<br>templates = Jinja2Templates(directory=<span class="hljs-string">&quot;templates&quot;</span>)<br><br><span class="hljs-comment"># Mount static files</span><br>app.mount(<span class="hljs-string">&quot;/static&quot;</span>, StaticFiles(directory=<span class="hljs-string">&quot;static&quot;</span>), name=<span class="hljs-string">&quot;static&quot;</span>)<br><br><span class="hljs-comment"># Pydantic models for API</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoInfoRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    url: <span class="hljs-built_in">str</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    url: <span class="hljs-built_in">str</span><br>    format_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-string">&quot;best&quot;</span><br><br><span class="hljs-comment"># Progress callback function</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_task_progress</span>(<span class="hljs-params">task_id: <span class="hljs-built_in">int</span>, progress: <span class="hljs-built_in">float</span>, status: TaskStatus, </span><br><span class="hljs-params">                        file_path: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>, error_message: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Update task progress in database&quot;&quot;&quot;</span><br>    db = <span class="hljs-built_in">next</span>(get_db())<br>    <span class="hljs-keyword">try</span>:<br>        task = db.query(DownloadTask).<span class="hljs-built_in">filter</span>(DownloadTask.<span class="hljs-built_in">id</span> == task_id).first()<br>        <span class="hljs-keyword">if</span> task:<br>            task.progress = progress<br>            task.status = status<br>            <span class="hljs-keyword">if</span> file_path:<br>                <span class="hljs-comment"># Handle file path properly</span><br>                <span class="hljs-keyword">if</span> os.path.isabs(file_path):<br>                    task.file_path = os.path.relpath(file_path, DOWNLOAD_DIR)<br>                <span class="hljs-keyword">else</span>:<br>                    task.file_path = file_path<br>                <br>                <span class="hljs-comment"># Get file size</span><br>                full_path = os.path.join(DOWNLOAD_DIR, task.file_path)<br>                <span class="hljs-keyword">if</span> os.path.exists(full_path):<br>                    task.file_size = os.path.getsize(full_path)<br>                    <br>            <span class="hljs-keyword">if</span> error_message:<br>                task.error_message = error_message<br>            db.commit()<br>    <span class="hljs-keyword">finally</span>:<br>        db.close()<br><br><span class="hljs-comment"># API Routes</span><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span>, response_class=HTMLResponse</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>(<span class="hljs-params">request: Request</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Serve the main page&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">&quot;index.html&quot;</span>, &#123;<span class="hljs-string">&quot;request&quot;</span>: request&#125;)<br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/api/video-info&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_video_info</span>(<span class="hljs-params">request: VideoInfoRequest</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Get video information&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        info = downloader.get_video_info(request.url)<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;data&quot;</span>: info&#125;<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-built_in">str</span>(e))<br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/api/download&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">start_download</span>(<span class="hljs-params">request: DownloadRequest, db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Start download task&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># Get video info first</span><br>        video_info = downloader.get_video_info(request.url)<br>        <br>        <span class="hljs-comment"># Create task record</span><br>        task = DownloadTask(<br>            url=request.url,<br>            title=video_info.get(<span class="hljs-string">&#x27;title&#x27;</span>),<br>            format_id=request.format_id,<br>            status=TaskStatus.PENDING<br>        )<br>        db.add(task)<br>        db.commit()<br>        db.refresh(task)<br>        <br>        <span class="hljs-comment"># Start download</span><br>        downloader.download_video(<br>            task.<span class="hljs-built_in">id</span>, <br>            request.url, <br>            request.format_id,<br>            update_task_progress<br>        )<br>        <br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;task_id&quot;</span>: task.<span class="hljs-built_in">id</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Download started&quot;</span>&#125;<br>        <br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-built_in">str</span>(e))<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/api/tasks&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tasks</span>(<span class="hljs-params">db: Session = Depends(<span class="hljs-params">get_db</span>)</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]:<br>    <span class="hljs-string">&quot;&quot;&quot;Get all download tasks&quot;&quot;&quot;</span><br>    tasks = db.query(DownloadTask).order_by(DownloadTask.created_at.desc()).<span class="hljs-built_in">all</span>()<br>    <span class="hljs-keyword">return</span> [task.to_dict() <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks]<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/api/download-file/&#123;task_id&#125;&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">task_id: <span class="hljs-built_in">int</span>, db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Serve downloaded file&quot;&quot;&quot;</span><br>    task = db.query(DownloadTask).<span class="hljs-built_in">filter</span>(DownloadTask.<span class="hljs-built_in">id</span> == task_id).first()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> task <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> task.file_path:<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">&quot;File not found&quot;</span>)<br>    <br>    file_path = os.path.join(DOWNLOAD_DIR, task.file_path)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(file_path):<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">&quot;File not found&quot;</span>)<br>    <br>    <span class="hljs-keyword">return</span> FileResponse(<br>        file_path,<br>        filename=os.path.basename(file_path),<br>        media_type=<span class="hljs-string">&#x27;application/octet-stream&#x27;</span><br>    )<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">import</span> uvicorn<br>    uvicorn.run(<span class="hljs-string">&quot;main:app&quot;</span>, host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, port=<span class="hljs-number">8000</span>, reload=<span class="hljs-literal">True</span>)<br><br></code></pre></td></tr></table></figure><h3 id="4-下载-Web-预览"><a href="#4-下载-Web-预览" class="headerlink" title="4. 下载 Web 预览"></a>4. <strong>下载 Web 预览</strong></h3><p>运行脚本时，你应该看到如下输出：</p><h4 id="分析视频-URL"><a href="#分析视频-URL" class="headerlink" title="分析视频 URL"></a>分析视频 URL</h4><!-- ![Logo](Building-a-YouTube-Downloader-with-FastAPI/create_new.png) --><img src="/2025/06/07/Building-a-YouTube-Downloader-with-FastAPI/create_new.png" class="" title="create_new"><h4 id="选择你喜欢的格式"><a href="#选择你喜欢的格式" class="headerlink" title="选择你喜欢的格式"></a>选择你喜欢的格式</h4><!-- ![Logo](Building-a-YouTube-Downloader-with-FastAPI/formats.png) --><img src="/2025/06/07/Building-a-YouTube-Downloader-with-FastAPI/formats.png" class="" title="formats"><h4 id="检查下载进度"><a href="#检查下载进度" class="headerlink" title="检查下载进度"></a>检查下载进度</h4><!-- ![Logo](Building-a-YouTube-Downloader-with-FastAPI/download_progress.png) --><img src="/2025/06/07/Building-a-YouTube-Downloader-with-FastAPI/download_progress.png" class="" title="download_progress"><h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. <strong>测试</strong></h3><p>在下载过程中监控服务器性能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Check server logs for performance metrics</span><br>INFO:     <span class="hljs-string">&quot;POST /api/video-info HTTP/1.1&quot;</span> 200 OK<br>INFO:     <span class="hljs-string">&quot;POST /api/download HTTP/1.1&quot;</span> 200 OK<br>INFO:     <span class="hljs-string">&quot;GET /api/tasks/1 HTTP/1.1&quot;</span> 200 OK<br>📥 Starting download <span class="hljs-keyword">for</span> task 1<br>🔗 URL: https://www.youtube.com/watch?v=dQw4w9WgXcQ<br>📋 Format: worst<br>📂 Output template: ./downloads/%(title)s-%(<span class="hljs-built_in">id</span>)s.%(ext)s<br>🚀 Starting yt-dlp download...<br>✅ File saved: ./downloads/Rick Astley - Never Gonna Give You Up-dQw4w9WgXcQ.mp4 (Size: 3847291 bytes)<br>✅ Download completed <span class="hljs-keyword">for</span> task 1<br></code></pre></td></tr></table></figure><h2 id="未来增强功能"><a href="#未来增强功能" class="headerlink" title="未来增强功能"></a>未来增强功能</h2><ul><li><strong>播放列表支持</strong>：下载整个播放列表</li><li><strong>用户认证</strong>：多用户支持</li><li><strong>下载调度</strong>：队列和计划下载</li><li><strong>云存储</strong>：与云存储服务集成</li><li><strong>移动应用</strong>：React Native 或 Flutter 移动应用</li><li><strong>Docker 支持</strong>：容器化部署</li></ul><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><ul><li><a href="https://github.com/gzthss/fastapi_tutorial.git">本项目代码</a></li><li><a href="https://fastapi.tiangolo.com/">FastAPI 文档</a></li><li><a href="https://github.com/yt-dlp/yt-dlp">yt-dlp GitHub 仓库</a></li><li><a href="https://docs.sqlalchemy.org/">SQLAlchemy 文档</a></li><li><a href="https://getbootstrap.com/docs/">Bootstrap 文档</a></li></ul><hr><p><em>Coding</em> </p>]]></content>
    
    
    <categories>
      
      <category>Web Development</category>
      
      <category>Python</category>
      
      <category>FastAPI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FastAPI</tag>
      
      <tag>Python</tag>
      
      <tag>yt-dlp</tag>
      
      <tag>YouTube</tag>
      
      <tag>Web Development</tag>
      
      <tag>API</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FastAPI 中的异步编程：你需要了解的知识</title>
    <link href="/2025/05/21/Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/"/>
    <url>/2025/05/21/Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/</url>
    
    <content type="html"><![CDATA[<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>FastAPI 是增长最快的 Python Web 框架之一，其突出特性之一就是对异步编程的支持。但”async”在实践中到底意味着什么？什么时候应该使用它，什么时候应该避免使用它？</p><p>在这篇文章中，我们将分解 FastAPI 中异步编程的要点。无论你是 async&#x2F;await 的新手，还是想知道它如何影响你的 API 性能，这篇文章将帮助你理解这些概念，并编写更好、更快的 Web 应用程序。</p><h3 id="2-什么是异步编程？"><a href="#2-什么是异步编程？" class="headerlink" title="2. 什么是异步编程？"></a>2. 什么是异步编程？</h3><p>在传统的（同步）Python 代码中，每个操作都是按顺序发生的。如果你的代码需要等待某些东西——比如文件加载或网络响应——它会阻塞整个线程，直到该操作完成。<br><em><strong>FastAPI 异步请求流程</strong></em></p><!-- ![mermaid_chart](./Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/mermaid_chart.png) --><img src="/2025/05/21/Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/mermaid_chart.png" class="" title="mermaid_chart"><p>异步编程改变了这一点。异步代码不是等待，而是在等待时<em>暂停</em>执行，同时让其他任务运行。这对于 I&#x2F;O 密集型任务特别有用，例如：</p><ul><li>发起 HTTP 请求</li><li>读取&#x2F;写入文件</li><li>与数据库通信</li></ul><p>使用 Python 的 <code>async def</code> 和 <code>await</code> 语法，你可以定义协程，高效地并发处理许多 I&#x2F;O 操作——而无需创建新线程或进程。</p><h3 id="3-Python-中的异步与同步：快速入门"><a href="#3-Python-中的异步与同步：快速入门" class="headerlink" title="3. Python 中的异步与同步：快速入门"></a>3. Python 中的异步与同步：快速入门</h3><p>在深入了解 FastAPI 的异步功能之前，理解 Python 中同步和异步代码的区别至关重要。</p><p>在同步代码中，所有操作都是按顺序运行的。如果一个函数需要时间（例如，获取网页），整个程序会暂停，直到该任务完成：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data</span>():<br>    response = requests.get(<span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span>)<br>    <span class="hljs-keyword">return</span> response.json()<br><br><span class="hljs-comment"># This call blocks until the response is returned</span><br>data = get_data()<br></code></pre></td></tr></table></figure><p>相比之下，异步代码使用 async def 定义协程，使用 await 暂停协程直到结果准备好——而不会阻塞其他任务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] get_data start&quot;</span>)<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:<br>        response = <span class="hljs-keyword">await</span> client.get(<span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] get_data end&quot;</span>)<br>        <span class="hljs-keyword">return</span> response.json()<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">quick_task</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] quick_task start&quot;</span>)<br>    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] quick_task end&quot;</span>)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    task1 = asyncio.create_task(get_data())<br>    task2 = asyncio.create_task(quick_task())<br>    <br>    <span class="hljs-keyword">await</span> asyncio.gather(task1, task2)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    asyncio.run(main())<br></code></pre></td></tr></table></figure><!-- ![async_get_data](./Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/async_get_data.png) --><img src="/2025/05/21/Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/async_get_data.png" class="" title="async_get_data"><p>所以，你可以看到 <code>get_data</code> 不会阻塞 <code>quick_task</code> 函数。</p><p><em><strong>主要区别：</strong></em></p><table><thead><tr><th>特性</th><th>同步 (<code>def</code>)</th><th>异步 (<code>async def</code>)</th></tr></thead><tbody><tr><td>阻塞性</td><td>是</td><td>否（使用 <code>await</code> 时）</td></tr><tr><td>并发运行</td><td>否</td><td>是（使用事件循环）</td></tr><tr><td>适用于</td><td>CPU 密集型任务</td><td>I&#x2F;O 密集型任务</td></tr></tbody></table><p><strong>注意：仅仅编写 async def 并不会让你的函数并行运行——你仍然需要在其中 await 异步调用。</strong></p><hr><h3 id="4-为什么异步在-FastAPI-中很重要"><a href="#4-为什么异步在-FastAPI-中很重要" class="headerlink" title="4. 为什么异步在 FastAPI 中很重要"></a>4. 为什么异步在 FastAPI 中很重要</h3><p>FastAPI 构建在 <code>Starlette</code> 之上，这是一个 ASGI（异步服务器网关接口）框架。这使 FastAPI 能够原生支持使用 Python 的 async&#x2F;await 语法的异步端点。</p><p>这意味着 FastAPI 可以处理许多 I&#x2F;O 密集型操作——比如从数据库读取、调用外部 API 或流式传输数据——<strong>而不会阻塞主线程</strong>。这在高负载下带来更高的性能，特别是在实时和高并发环境中。</p><p>以下是 FastAPI 中异步路由的样子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><span class="hljs-keyword">import</span> httpx<br><br>app = FastAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/quote&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_quote</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:<br>        response = <span class="hljs-keyword">await</span> client.get(<span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span>)<br>        <span class="hljs-keyword">return</span> response.json()<br></code></pre></td></tr></table></figure><p>因为这个端点是异步的，FastAPI 可以在等待 API 响应的同时继续处理其他请求——从而提高吞吐量和响应性。</p><p>🧠 <strong>需要了解</strong>：你仍然可以使用普通的 def 定义同步端点，FastAPI 会在线程池中运行它们——但异步函数对于 I&#x2F;O 密集型操作更高效。</p><h3 id="5-在-FastAPI-中定义异步端点"><a href="#5-在-FastAPI-中定义异步端点" class="headerlink" title="5. 在 FastAPI 中定义异步端点"></a>5. 在 FastAPI 中定义异步端点</h3><p>FastAPI 使定义异步端点变得非常简单。你只需要使用 <code>async def</code> 声明路由处理器，并在其中使用 <code>await</code> 处理任何 I&#x2F;O 密集型操作。</p><p>以下是一个最小示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><br>app = FastAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/ping&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ping</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>在这个例子中，<code>/ping</code> 路由使用 async def 定义，但由于它不执行任何真正的 I&#x2F;O 操作，所以它像普通函数一样运行。只有当你使用 await 与异步兼容的库时，才能获得性能优势。</p><p>让我们比较同一个端点的异步和同步版本<br><strong>异步版本（推荐用于 I&#x2F;O 密集型任务）：</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/async-quote&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_quote</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:<br>        response = <span class="hljs-keyword">await</span> client.get(<span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span>)<br>        <span class="hljs-keyword">return</span> response.json()<br><br><span class="hljs-comment"># 同步版本（也支持）：</span><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/sync-quote&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sync_quote</span>():<br>    response = requests.get(<span class="hljs-string">&quot;https://httpbin.org/delay/3&quot;</span>)<br>    <span class="hljs-keyword">return</span> response.json()<br><br></code></pre></td></tr></table></figure><p>🔥 FastAPI 同时支持 def 和 async def 端点。然而，只有 async def 端点才能充分利用 FastAPI 的非阻塞 ASGI 堆栈来实现高并发。<br>在内部，FastAPI 会在线程池中运行基于 def 的函数（通过 run_in_threadpool），这会增加一些开销，并且在处理数千个并发连接时扩展性不佳。</p><h3 id="6-await-实战：I-O-密集型示例（使用异步数据库）"><a href="#6-await-实战：I-O-密集型示例（使用异步数据库）" class="headerlink" title="6. await 实战：I&#x2F;O 密集型示例（使用异步数据库）"></a>6. await 实战：I&#x2F;O 密集型示例（使用异步数据库）</h3><p>在 FastAPI 中，<code>await</code> 最常见和最强大的用途之一是处理 I&#x2F;O 密集型操作，如查询数据库。在同步代码中，此类操作会阻塞主线程。但使用异步驱动程序，FastAPI 可以并发处理许多请求，即使有些请求正在等待数据库响应。</p><p>以下是一个使用 FastAPI 与 <a href="https://sqlmodel.tiangolo.com/">SQLModel</a> 以及由 SQLAlchemy 1.4+ 和 <code>asyncpg</code> 驱动的异步引擎的实用示例。</p><p><strong>本文的代码位于名为 04_fastapi_async 的 GitHub 仓库中。</strong><br><a href="https://github.com/gzthss/fastapi_tutorial.git">https://github.com/gzthss/fastapi_tutorial.git</a></p><h4 id="🔧-设置：安装依赖"><a href="#🔧-设置：安装依赖" class="headerlink" title="🔧 设置：安装依赖"></a>🔧 设置：安装依赖</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pip install sqlmodel[asyncio] asyncpg<br></code></pre></td></tr></table></figure><p>让我们通过一个使用 <strong>SQLModel</strong>（来自 FastAPI 创建者的异步兼容 ORM）和 Postgresql 的实用示例来了解。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># models.py</span><br><span class="hljs-keyword">from</span> sqlmodel <span class="hljs-keyword">import</span> SQLModel, Field<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(SQLModel, table=<span class="hljs-literal">True</span>):<br>    <span class="hljs-built_in">id</span>: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(default=<span class="hljs-literal">None</span>, primary_key=<span class="hljs-literal">True</span>)<br>    name: <span class="hljs-built_in">str</span><br>    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span><br><br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># database.py</span><br><span class="hljs-keyword">from</span> sqlmodel <span class="hljs-keyword">import</span> SQLModel<br><span class="hljs-keyword">from</span> sqlmodel.ext.asyncio.session <span class="hljs-keyword">import</span> AsyncSession<br><span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> create_async_engine, async_sessionmaker<br><br>database_url = <span class="hljs-string">&quot;postgresql+asyncpg://postgres:admin123@192.168.1.11:5432/postgres&quot;</span><br><br>engine = create_async_engine(database_url, echo=<span class="hljs-literal">True</span>)<br>async_session = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=<span class="hljs-literal">False</span>)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> async_session() <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">yield</span> session<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_db</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> engine.begin() <span class="hljs-keyword">as</span> conn:<br>        <span class="hljs-keyword">await</span> conn.run_sync(SQLModel.metadata.create_all)<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># main.py</span><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, Depends<br><span class="hljs-keyword">from</span> sqlmodel <span class="hljs-keyword">import</span> select<br><span class="hljs-keyword">import</span> uvicorn<br><span class="hljs-keyword">from</span> database <span class="hljs-keyword">import</span> init_db, engine, get_session<br><span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> Item<br><span class="hljs-keyword">from</span> sqlmodel.ext.asyncio.session <span class="hljs-keyword">import</span> AsyncSession<br><br>app = FastAPI()<br><br><span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">&quot;startup&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup</span>():<br>    <span class="hljs-keyword">await</span> init_db()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, session: AsyncSession = Depends(<span class="hljs-params">get_session</span>)</span>):<br>    query = select(Item).where(Item.<span class="hljs-built_in">id</span> == item_id)<br>    result = <span class="hljs-keyword">await</span> session.<span class="hljs-built_in">exec</span>(query)<br>    item = result.one_or_none()<br>    <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">&quot;Item not found&quot;</span>)<br>    <span class="hljs-keyword">return</span> item<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    uvicorn.run(app, host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, port=<span class="hljs-number">8000</span>)<br></code></pre></td></tr></table></figure><p><strong>下图显示了 API 调用的结果。</strong></p><!-- ![get_item](./Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/get_items.png) --><img src="/2025/05/21/Asynchronous-Programming-in-FastAPI-What-You-Need-to-Know/get_items.png" class="" title="get_items"><p>希望这篇文章能帮助你更好地理解 FastAPI 中的异步编程，并在实际项目中提升你的 API 性能。如果你觉得有帮助，欢迎与他人分享！</p>]]></content>
    
    
    
    <tags>
      
      <tag>FastAPI</tag>
      
      <tag>Async</tag>
      
      <tag>httpx</tag>
      
      <tag>asyncio</tag>
      
      <tag>Postgresql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>​JWT Authentication in FastAPI:Securing Your API​</title>
    <link href="/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/"/>
    <url>/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/</url>
    
    <content type="html"><![CDATA[<p>(This section is part of Blog Post 2: “Advanced FastAPI: Databases, Auth, and Async”)</p><h3 id="What-is-JWT-and-How-Does-It-Work"><a href="#What-is-JWT-and-How-Does-It-Work" class="headerlink" title="What is JWT and How Does It Work?"></a>What is JWT and How Does It Work?</h3><p>JWT (JSON Web Token) is an open standard (RFC 7519) for securely transmitting information between parties as a JSON object.</p><p>JWT is commonly used for authentication and information exchange. It consists of three parts: Header, Payload, and Signature.</p><ul><li>Header: Specifies the type (JWT) and the signing algorithm (e.g., HS256).</li><li>Payload: Contains the actual data to be transmitted (such as user ID, expiration time, etc.), and can be customized.</li><li>Signature: Created by encrypting the first two parts with a secret key to prevent tampering.</li></ul><p>The advantages of JWT are its simple structure, easy transmission, cross-language support, and stateless user authentication. It is widely used in web application login authentication and API authorization scenarios.</p><h3 id="Integrating-JWT-Authentication-into-Your-FastAPI-Project"><a href="#Integrating-JWT-Authentication-into-Your-FastAPI-Project" class="headerlink" title="Integrating JWT Authentication into Your FastAPI Project"></a>Integrating JWT Authentication into Your FastAPI Project</h3><h4 id="JWT-Authentication-Flow-Sequence-Diagram"><a href="#JWT-Authentication-Flow-Sequence-Diagram" class="headerlink" title="JWT Authentication Flow Sequence Diagram"></a>JWT Authentication Flow Sequence Diagram</h4><img src="/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/diagrams.svg" class="" title="diagrams"><h5 id="​Step-1-Install-Required-Libraries​"><a href="#​Step-1-Install-Required-Libraries​" class="headerlink" title="​Step 1: Install Required Libraries​"></a>​Step 1: Install Required Libraries​</h5><p>JWT requires cryptographic libraries for token signing and password hashing</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pip install <span class="hljs-string">&quot;python-jose[cryptography]&quot;</span> <span class="hljs-string">&quot;passlib[bcrypt]&quot;</span><br></code></pre></td></tr></table></figure><p>​<strong>python-jose</strong>: Handles JWT creation&#x2F;validation (supports multiple algorithms like HS256).<br>​<strong>passlib</strong>: Securely hashes passwords using ​bcrypt​ (industry-standard for password storage).</p><h5 id="​Step-2-Implementation-Steps"><a href="#​Step-2-Implementation-Steps" class="headerlink" title="​Step 2: Implementation Steps"></a>​Step 2: Implementation Steps</h5><p><strong>The code for this article is located in the GitHub repository named 03_fastapi_jwt.</strong><br><a href="https://github.com/gzthss/fastapi_tutorial.git">https://github.com/gzthss/fastapi_tutorial.git</a></p><p>For detailed information about the database section, please refer to my other article:<br><a href="https://gzthss.com/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/">Advanced FastAPI: Databases…</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">project/<br>├── db/<br>│ └── app.db            <span class="hljs-comment"># sqlite db</span><br>│ └── database.py       <span class="hljs-comment"># Database connection and session management</span><br>│ └── models.py         <span class="hljs-comment"># Database models and table definitions</span><br>│<br>├── routers/  <br>│   └── auth.py         <span class="hljs-comment"># Authentication routes  </span><br>│<br>├── utils/<br>│ └── security.py       <span class="hljs-comment"># JWT/password utilities       </span><br>│ └── schemas.py        <span class="hljs-comment"># Pydantic data models  </span><br>│ └── dependencies.py   <span class="hljs-comment"># Auth dependencies</span><br>│<br>└── main.py             <span class="hljs-comment"># Main app setup  </span><br></code></pre></td></tr></table></figure><p><strong>routers&#x2F;auth.py</strong>​</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Authentication routes and user management   </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Depends, HTTPException, status<br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> Session<br><br><span class="hljs-keyword">from</span> utils.security <span class="hljs-keyword">import</span> get_password_hash, verify_password, create_access_token<br><span class="hljs-keyword">from</span> utils.schemas <span class="hljs-keyword">import</span> UserCreate, TokenResponse<br><span class="hljs-keyword">from</span> utils.dependencies <span class="hljs-keyword">import</span> get_current_user<br><br><span class="hljs-keyword">from</span> db.database <span class="hljs-keyword">import</span> get_db<br><span class="hljs-keyword">from</span> db.models <span class="hljs-keyword">import</span> User<br><br>router = APIRouter(prefix=<span class="hljs-string">&quot;/auth&quot;</span>, tags=[<span class="hljs-string">&quot;Authentication&quot;</span>])<br><br><span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">&quot;/register&quot;</span>, status_code=status.HTTP_201_CREATED</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_user</span>(<span class="hljs-params">user: UserCreate, db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;User registration endpoint.&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Check for existing user</span><br>    existing_user = db.query(User).<span class="hljs-built_in">filter</span>(<br>        (User.user_name == user.username) | (User.email == user.email)<br>    ).first()<br>    <span class="hljs-keyword">if</span> existing_user:<br>        <span class="hljs-keyword">raise</span> HTTPException(<br>            status_code=status.HTTP_400_BAD_REQUEST,<br>            detail=<span class="hljs-string">&quot;Username or email already registered.&quot;</span><br>        )<br><br>    Hash password &amp; save user<br>    hashed_password = get_password_hash(user.password)<br>    new_user = User(<br>        user_name=user.username,<br>        email=user.email,<br>        hashed_password=hashed_password<br>    )<br>    db.add(new_user)<br>    db.commit()<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;User registered successfully&quot;</span>&#125;<br><br><span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">&quot;/token&quot;</span>, response_model=TokenResponse</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">login_for_access_token</span>(<span class="hljs-params">username: <span class="hljs-built_in">str</span>,password: <span class="hljs-built_in">str</span>,db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Login endpoint returning JWT.&quot;&quot;&quot;</span><br>    user = db.query(User).<span class="hljs-built_in">filter</span>(User.user_name == username).first()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> verify_password(password, user.hashed_password):<br>        <span class="hljs-keyword">raise</span> HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED,<br>            detail=<span class="hljs-string">&quot;Incorrect username or password&quot;</span>,<br>            headers=&#123;<span class="hljs-string">&quot;WWW-Authenticate&quot;</span>: <span class="hljs-string">&quot;Bearer&quot;</span>&#125;,<br>        )<br><br>    <span class="hljs-comment">#Generate JWT</span><br>    access_token = create_access_token(data=&#123;<span class="hljs-string">&quot;sub&quot;</span>: user.user_name&#125;)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;access_token&quot;</span>: access_token, <span class="hljs-string">&quot;token_type&quot;</span>: <span class="hljs-string">&quot;bearer&quot;</span>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>utils&#x2F;schemas.py</strong>​</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># routers/schemas.py</span><br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;JWT Token payload schema.&quot;&quot;&quot;</span><br>    username: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCreate</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;User registration request schema.&quot;&quot;&quot;</span><br>    username: <span class="hljs-built_in">str</span><br>    password: <span class="hljs-built_in">str</span><br>    email: <span class="hljs-built_in">str</span><br>    <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Login response schema.&quot;&quot;&quot;</span><br>    access_token: <span class="hljs-built_in">str</span><br>    token_type: <span class="hljs-built_in">str</span><br></code></pre></td></tr></table></figure><p><strong>utils&#x2F;dependencies.py</strong>​ </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># dependencies.py</span><br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException, Depends, status<br><span class="hljs-keyword">from</span> fastapi.security <span class="hljs-keyword">import</span> OAuth2PasswordBearer<br><span class="hljs-keyword">from</span> jose <span class="hljs-keyword">import</span> jwt, JWTError<br><br><span class="hljs-keyword">from</span> utils.schemas <span class="hljs-keyword">import</span> TokenData<br><span class="hljs-keyword">from</span> utils.security <span class="hljs-keyword">import</span> decode_token<br><br>oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="hljs-string">&quot;/auth/token&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_user</span>(<span class="hljs-params">token: <span class="hljs-built_in">str</span> = Depends(<span class="hljs-params">oauth2_scheme</span>)</span>) -&gt; TokenData:<br>    <span class="hljs-string">&quot;&quot;&quot;Dependency to validate JWT.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        payload = decode_token(token)<br>        username: <span class="hljs-built_in">str</span> = payload.get(<span class="hljs-string">&quot;sub&quot;</span>) <br>        <span class="hljs-keyword">if</span> username <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> JWTError<br>        <span class="hljs-keyword">return</span> TokenData(username=username)<br>    <span class="hljs-keyword">except</span> JWTError:<br>        <span class="hljs-keyword">raise</span> HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED,<br>            detail=<span class="hljs-string">&quot;Could not validate credentials&quot;</span>,<br>            headers=&#123;<span class="hljs-string">&quot;WWW-Authenticate&quot;</span>: <span class="hljs-string">&quot;Bearer&quot;</span>&#125;,<br>        )<br></code></pre></td></tr></table></figure><p><strong>utils&#x2F;security.py</strong>​  </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># security.py is used to create and decode JWT tokens.</span><br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta<br><span class="hljs-keyword">from</span> jose <span class="hljs-keyword">import</span> jwt,JWTError<br><span class="hljs-keyword">from</span> passlib.context <span class="hljs-keyword">import</span> CryptContext<br><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException, status<br><br><span class="hljs-comment"># -----------------------------</span><br><span class="hljs-comment"># Password Hashing Config</span><br><span class="hljs-comment"># -----------------------------</span><br><br>pwd_context = CryptContext(schemes=[<span class="hljs-string">&quot;bcrypt&quot;</span>], deprecated=<span class="hljs-string">&quot;auto&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_password</span>(<span class="hljs-params">plain_password: <span class="hljs-built_in">str</span>, hashed_password: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Verify plain password against hash.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> pwd_context.verify(plain_password, hashed_password)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_password_hash</span>(<span class="hljs-params">password: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Generate bcrypt hash from password.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> pwd_context.<span class="hljs-built_in">hash</span>(password)<br><br><span class="hljs-comment"># -----------------------------</span><br><span class="hljs-comment"># JWT Configuration</span><br><span class="hljs-comment"># -----------------------------</span><br><br>SECRET_KEY = <span class="hljs-string">&quot;f072b58f044a20bd1488f6d8d2f002af5715011952d185fa84750421282defba&quot;</span><br>ALGORITHM = <span class="hljs-string">&quot;HS256&quot;</span><br>ACCESS_TOKEN_EXPIRE_MINUTES = <span class="hljs-number">30</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_access_token</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span>, expires_delta: timedelta = <span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Generate JWT with expiration.&quot;&quot;&quot;</span><br>    to_encode = data.copy()<br>    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)<br>    to_encode.update(&#123;<span class="hljs-string">&quot;exp&quot;</span>: expire&#125;)  <span class="hljs-comment"># </span><br>    <span class="hljs-keyword">return</span> jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode_token</span>(<span class="hljs-params">token: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:<br>    <span class="hljs-string">&quot;&quot;&quot; Validate and decode JWT.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])<br>        <span class="hljs-keyword">return</span> payload<br>    <span class="hljs-keyword">except</span> JWTError:<br>        <span class="hljs-keyword">raise</span> HTTPException(<br>            status_code=status.HTTP_401_UNAUTHORIZED,<br>            detail=<span class="hljs-string">&quot;Invalid authentication credentials&quot;</span>,<br>            headers=&#123;<span class="hljs-string">&quot;WWW-Authenticate&quot;</span>: <span class="hljs-string">&quot;Bearer&quot;</span>&#125;,<br>        )<br></code></pre></td></tr></table></figure><p><strong>&#x2F;main.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, Depends<br><span class="hljs-keyword">from</span> routers <span class="hljs-keyword">import</span> auth<br><span class="hljs-keyword">from</span> utils.dependencies <span class="hljs-keyword">import</span> get_current_user<br><span class="hljs-keyword">from</span> utils.schemas <span class="hljs-keyword">import</span> TokenData<br><span class="hljs-keyword">import</span> uvicorn<br><br>app = FastAPI()<br><br>app.include_router(auth.router)<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/secure-data&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_secure_data</span>(<span class="hljs-params">current_user: TokenData = Depends(<span class="hljs-params">get_current_user</span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Example protected route.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot; Hello <span class="hljs-subst">&#123;current_user.username&#125;</span>, this is sensitive data!&quot;</span>,<br>        <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;Authorized&quot;</span><br>    &#125;<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    uvicorn.run(app, host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, port=<span class="hljs-number">8000</span>)<br><br></code></pre></td></tr></table></figure><h5 id="​Step-3-Testing-the-Flow-With-Postman"><a href="#​Step-3-Testing-the-Flow-With-Postman" class="headerlink" title="​Step 3: Testing the Flow With Postman"></a>​Step 3: Testing the Flow With Postman</h5><ul><li>Let’s create a user first.</li></ul><!-- ![Logo](JWT-Authentication-in-FastAPI-Securing-Your-API/creat_user.png) --><img src="/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/creat_user.png" class="" title="creat_user"><ul><li>Use the user you just created to log in and get token<!-- ![Logo](JWT-Authentication-in-FastAPI-Securing-Your-API/user_login.png) --></li></ul><img src="/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/user_login.png" class="" title="user_login"><ul><li>Use the token to call the authorized API endpoint.<!-- [Logo](JWT-Authentication-in-FastAPI-Securing-Your-API/use_token.png) --></li></ul><img src="/2025/05/14/JWT-Authentication-in-FastAPI-Securing-Your-API/use_token.png" class="" title="use_token"><p>This is the process of using JWT for authorization and encryption in FastAPI. See you next time!</p>]]></content>
    
    
    
    <tags>
      
      <tag>FastAPI</tag>
      
      <tag>SQLAlchemy</tag>
      
      <tag>JWT</tag>
      
      <tag>Async</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Advanced FastAPI: Databases, Auth, and Async</title>
    <link href="/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/"/>
    <url>/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/</url>
    
    <content type="html"><![CDATA[<p>FastAPI does not impose any restrictions on database tools,but SQLAlchemy is one of the most powerful ORMs in the python ecosystem. This section will teach you how to configure a database from scratch.</p><h3 id="1-Database-Integration-with-SQLAlchemy"><a href="#1-Database-Integration-with-SQLAlchemy" class="headerlink" title="1.Database Integration with SQLAlchemy"></a>1.Database Integration with SQLAlchemy</h3><h5 id="Step-1-Install-Dependencies"><a href="#Step-1-Install-Dependencies" class="headerlink" title="Step 1: Install Dependencies"></a>Step 1: Install Dependencies</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install sqlalchemy<br></code></pre></td></tr></table></figure><h5 id="Step-2-Define-Data-Models"><a href="#Step-2-Define-Data-Models" class="headerlink" title="Step 2: Define Data Models"></a>Step 2: Define Data Models</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># models.py</span><br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Integer, String<br><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base<br><br>Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;users&quot;</span><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)<br>    username = Column(String(<span class="hljs-number">50</span>), unique=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)  <br>    email = Column(String(<span class="hljs-number">100</span>), unique=<span class="hljs-literal">True</span>)                <br>    hashed_password = Column(String(<span class="hljs-number">200</span>))  <br></code></pre></td></tr></table></figure><p>declarative_base(): Creates a base class for models, similar to Django’s models.Model<br>Column: Defines a table field, such as Integer, String, etc.</p><h5 id="Step-3-Initialize-Database-Session"><a href="#Step-3-Initialize-Database-Session" class="headerlink" title="Step 3: Initialize Database Session"></a>Step 3: Initialize Database Session</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># database.py</span><br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker<br><br>SQLALCHEMY_DATABASE_URL = <span class="hljs-string">&quot;sqlite:///./app.db&quot;</span><br>engine = create_engine(SQLALCHEMY_DATABASE_URL)<br>SessionLocal = sessionmaker(autocommit=<span class="hljs-literal">False</span>, autoflush=<span class="hljs-literal">False</span>, bind=engine)<br><br></code></pre></td></tr></table></figure><h5 id="Step-4-User-Creation-and-Database-Operations-with-FastAPI"><a href="#Step-4-User-Creation-and-Database-Operations-with-FastAPI" class="headerlink" title="Step 4: User Creation and Database Operations with FastAPI"></a>Step 4: User Creation and Database Operations with FastAPI</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># main.py</span><br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine<br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker<br><br><span class="hljs-comment"># Connect to SQLite (use PostgreSQL ofrom fastapi import FastAPI, Depends,HTTPException,status</span><br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><br><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> Session<br><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> text<br><br><span class="hljs-keyword">from</span> database <span class="hljs-keyword">import</span> engine, SessionLocal<br><span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> Base, User<br><span class="hljs-keyword">import</span> hashlib<br><br>app = FastAPI()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCreateRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    username: <span class="hljs-built_in">str</span><br>    password: <span class="hljs-built_in">str</span><br>    email: <span class="hljs-built_in">str</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db</span>():<br>    db = SessionLocal()<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">yield</span> db<br>    <span class="hljs-keyword">finally</span>:<br>        db.close()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_password_hash</span>(<span class="hljs-params">password: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-keyword">return</span> hashlib.sha256(password.encode()).hexdigest() <br><br><span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">&quot;startup&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Starting up...&quot;</span>)<br>    <span class="hljs-keyword">with</span> engine.begin() <span class="hljs-keyword">as</span> conn:<br>        table_exists = conn.execute(<br>            text(<span class="hljs-string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27; AND name=&#x27;users&#x27;&quot;</span>)<br>        )<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table_exists.scalar():<br>            Base.metadata.create_all(bind=engine)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Database tables created.&quot;</span>)<br>            <br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/users&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_users</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">int</span>, db: Session = Depends(<span class="hljs-params">get_db</span>)</span>):<br>    user = db.query(User).<span class="hljs-built_in">filter</span>(User.<span class="hljs-built_in">id</span> == user_id).first()<br>    <span class="hljs-keyword">return</span> user<br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/add_users/&quot;</span>, status_code=status.HTTP_201_CREATED</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_user</span>(<span class="hljs-params">user_data: UserCreateRequest,db: Session = Depends(<span class="hljs-params">get_db</span>)  </span><br><span class="hljs-params"></span>):<br>    <br>    existing_user = db.query(User).<span class="hljs-built_in">filter</span>(User.user_name == user_data.username).first()<br>    <span class="hljs-keyword">if</span> existing_user:<br>        <span class="hljs-keyword">raise</span> HTTPException(<br>            status_code=status.HTTP_400_BAD_REQUEST,<br>            detail=<span class="hljs-string">&quot;Username already registered.&quot;</span><br>        )<br><br>    hashed_password = get_password_hash(user_data.password)<br>    new_user = User(<br>        user_name=user_data.username,<br>        email=user_data.email,<br>        hashed_password=hashed_password<br>    )<br><br>    db.add(new_user)<br>    db.commit()<br>    db.refresh(new_user)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;User created successfully&quot;</span>, <span class="hljs-string">&quot;user_id&quot;</span>: new_user.<span class="hljs-built_in">id</span>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="Step-5-Run-the-application-with-uvicorn"><a href="#Step-5-Run-the-application-with-uvicorn" class="headerlink" title="Step 5: Run the application with uvicorn"></a>Step 5: Run the application with uvicorn</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">uvicorn main:app --reload<br></code></pre></td></tr></table></figure><!-- ![Logo](Advanced-FastAPI-Databases-Auth-and-Async/run_app.png) --><img src="/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/run_app.png" class="" title="APP"><h5 id="Step-6-Use-Postman-for-API-testing"><a href="#Step-6-Use-Postman-for-API-testing" class="headerlink" title="Step 6: Use Postman for API testing."></a>Step 6: Use Postman for API testing.</h5><ul><li>Use Postman to call the add_users endpoint to add a user</li></ul>  <!-- ![Logo](Advanced-FastAPI-Databases-Auth-and-Async/postman.png) --><img src="/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/postman.png" class="" title="Postman"><ul><li>Use Postman to call the users endpoint to view user information from the database<!-- ![Logo](Advanced-FastAPI-Databases-Auth-and-Async/postman_get.png) --></li></ul><img src="/2025/05/13/Advanced-FastAPI-Databases-Auth-and-Async/postman_get.png" class="" title="Postman_Get"><p>In summary, mastering FastAPI&#96;s advanced features—such as database integration, authentication, and asynchronous programming—empowers you to build robust, secure, and high-performance web APIs with ease.</p>]]></content>
    
    
    
    <tags>
      
      <tag>FastAPI</tag>
      
      <tag>SQLAlchemy</tag>
      
      <tag>JWT</tag>
      
      <tag>Async</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>从零开始构建 FastAPI RESTful API</title>
    <link href="/2025/05/12/Building-a-FastAPI-RESTful-API-from-Scratch/"/>
    <url>/2025/05/12/Building-a-FastAPI-RESTful-API-from-Scratch/</url>
    
    <content type="html"><![CDATA[<!-- ![Logo](./Building-a-FastAPI-RESTful-API-from-Scratch/title.png) --><img src="/2025/05/12/Building-a-FastAPI-RESTful-API-from-Scratch/title.png" class="" title="Title"><h3 id="1-FastAPI-简介"><a href="#1-FastAPI-简介" class="headerlink" title="1. FastAPI 简介"></a>1. FastAPI 简介</h3><p>为什么选择 FastAPI？</p><ul><li><p>高性能：<br> FastAPI 构建在 Starlette 和 Pydantic 之上，支持异步特性，其性能接近 Node.js 和 Go，远超 Flask 和 Django 等传统框架。</p></li><li><p>异步支持：<br>原生支持 async&#x2F;await，适用于高并发场景。</p></li><li><p>自动文档生成：<br>通过简单的注解，FastAPI 自动生成交互式 API 文档（Swagger UI 和 ReDoc），使开发和测试变得更加容易。</p></li></ul><h3 id="2-项目设置"><a href="#2-项目设置" class="headerlink" title="2. 项目设置"></a>2. 项目设置</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install fastapi uvicorn<br></code></pre></td></tr></table></figure><h3 id="3-创建你的第一个-API"><a href="#3-创建你的第一个-API" class="headerlink" title="3. 创建你的第一个 API"></a>3. 创建你的第一个 API</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><br>app = FastAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">root</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Hello World&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-添加路由和-Pydantic-模型"><a href="#4-添加路由和-Pydantic-模型" class="headerlink" title="4. 添加路由和 Pydantic 模型"></a>4. 添加路由和 Pydantic 模型</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    name: <span class="hljs-built_in">str</span><br>    price: <span class="hljs-built_in">float</span><br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/items/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;item&quot;</span>: item&#125;<br></code></pre></td></tr></table></figure><h3 id="5-一个简单的-FastAPI-应用示例"><a href="#5-一个简单的-FastAPI-应用示例" class="headerlink" title="5. 一个简单的 FastAPI 应用示例"></a>5. 一个简单的 FastAPI 应用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI<br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<br><span class="hljs-keyword">import</span> uvicorn<br>app = FastAPI()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    name: <span class="hljs-built_in">str</span><br>    price: <span class="hljs-built_in">float</span><br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">root</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Hello World&quot;</span>&#125;<br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/items/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;item.name&#125;</span> <span class="hljs-subst">&#123;item.price&#125;</span>&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    uvicorn.run(app, host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, port=<span class="hljs-number">8000</span>)<br></code></pre></td></tr></table></figure><p>下图显示了 FastAPI 自动生成的交互式 API 文档（Swagger UI），开发者可以直接在其中测试端点。</p><!-- ![Logo](./Building-a-FastAPI-RESTful-API-from-Scratch/doc.png) --><img src="/2025/05/12/Building-a-FastAPI-RESTful-API-from-Scratch/doc.png" class="" title="Doc">]]></content>
    
    
    
    <tags>
      
      <tag>FastAPI</tag>
      
      <tag>Python</tag>
      
      <tag>Backend</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>在 CentOS 7 上安装 Python 3.10+ 的逐步指南</title>
    <link href="/2025/05/10/%E2%80%8BStep-by-Step-Guide-to-Installing-Python-3-10-on-CentOS-7/"/>
    <url>/2025/05/10/%E2%80%8BStep-by-Step-Guide-to-Installing-Python-3-10-on-CentOS-7/</url>
    
    <content type="html"><![CDATA[<p>目标：在 CentOS 7 上安装 Python 3.10 或更高版本，同时保留系统默认的 Python 2.7 环境。</p><h3 id="步骤-1：安装必需的依赖项"><a href="#步骤-1：安装必需的依赖项" class="headerlink" title="步骤 1：安装必需的依赖项"></a>步骤 1：安装必需的依赖项</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> yum groupinstall -y <span class="hljs-string">&quot;Development Tools&quot;</span><br><span class="hljs-built_in">sudo</span> yum install -y openssl-devel bzip2-devel libffi-devel zlib-devel ncurses-devel sqlite-devel readline-devel tk-devel<br></code></pre></td></tr></table></figure><h3 id="步骤-2：下载-Python-3-10-源代码"><a href="#步骤-2：下载-Python-3-10-源代码" class="headerlink" title="步骤 2：下载 Python 3.10 源代码"></a>步骤 2：下载 Python 3.10 源代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://www.python.org/ftp/python/3.10.0/Python-3.10.0.tgz<br></code></pre></td></tr></table></figure><h3 id="步骤-3：解压并配置源代码"><a href="#步骤-3：解压并配置源代码" class="headerlink" title="步骤 3：解压并配置源代码"></a>步骤 3：解压并配置源代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar xzf Python-3.10.0.tgz<br><span class="hljs-built_in">cd</span> Python-3.10.0<br></code></pre></td></tr></table></figure><p>使用优化选项和自定义安装路径配置构建：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./configure --enable-optimizations --prefix=/usr/local<br></code></pre></td></tr></table></figure><h3 id="步骤-4：编译并安装-Python"><a href="#步骤-4：编译并安装-Python" class="headerlink" title="步骤 4：编译并安装 Python"></a>步骤 4：编译并安装 Python</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> make altinstall<br></code></pre></td></tr></table></figure><h3 id="步骤-5：验证安装"><a href="#步骤-5：验证安装" class="headerlink" title="步骤 5：验证安装"></a>步骤 5：验证安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3.10 --version<br></code></pre></td></tr></table></figure><p>预期输出：Python 3.10.0</p><h3 id="步骤-6：创建-python3-软链接（可选）​"><a href="#步骤-6：创建-python3-软链接（可选）​" class="headerlink" title="步骤 6：创建 python3 软链接（可选）​"></a>步骤 6：创建 python3 软链接（可选）​</h3><p>如果您想使用 python3 作为 python3.10 的快捷方式，请按照以下步骤操作：</p><h5 id="1-检查-Python-3-10-安装路径"><a href="#1-检查-Python-3-10-安装路径" class="headerlink" title="1. 检查 Python 3.10 安装路径"></a>1. 检查 Python 3.10 安装路径</h5><p>   默认情况下，Python 3.10 安装到 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3.10。验证这一点：<br>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> /usr/local/bin/python3.10<br></code></pre></td></tr></table></figure></p><h5 id="​2-创建软链接"><a href="#​2-创建软链接" class="headerlink" title="​2. 创建软链接"></a>​2. 创建软链接</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">ln</span> -s /usr/local/bin/python3.10 /usr/bin/python3<br></code></pre></td></tr></table></figure><h5 id="3-验证链接​"><a href="#3-验证链接​" class="headerlink" title="3. 验证链接​"></a>3. 验证链接​</h5><p>检查新的符号链接和版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -l /usr/bin/python3  <span class="hljs-comment"># Should point to /usr/local/bin/python3.10</span><br>python3 --version       <span class="hljs-comment"># Should show &quot;Python 3.10.x&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>CentOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
